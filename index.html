<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat with PeerJS</title>
    <style>
        /* Same styles as before */
    </style>
</head>
<body>

<div id="chat-container">
    <div id="messages"></div>
    <div id="message-input">
        <input type="text" id="peerId" placeholder="Enter Peer ID to connect or leave empty to create one..." />
        <button id="connect">Connect</button>
        <input type="text" id="username" placeholder="Enter your name..." disabled />
        <input type="text" id="message" placeholder="Type your message..." disabled />
        <input type="file" id="fileInput" disabled />
        <button id="send" disabled>Send</button>
    </div>
</div>

<!-- PeerJS Library -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.0/dist/peerjs.min.js"></script>

<script>
    const peerIdInput = document.getElementById("peerId");
    const connectButton = document.getElementById("connect");
    const usernameInput = document.getElementById("username");
    const messageInput = document.getElementById("message");
    const sendButton = document.getElementById("send");
    const fileInput = document.getElementById("fileInput");
    const messagesDiv = document.getElementById("messages");

    const MAX_FILE_SIZE_MB = 5; // 5 MB max file size
    let conn;
    let peer;

    // Function to display messages
    function addMessage(sender, message) {
        const messageDiv = document.createElement("div");
        messageDiv.textContent = `${sender}: ${message}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll to the bottom
    }

    // Function to connect to a peer
    function connectToPeer() {
        const peerID = peerIdInput.value.trim();
        if (peerID) {
            conn = peer.connect(peerID);
            conn.on('open', () => {
                enableChat();
                addMessage("System", "Connected to peer.");
            });

            conn.on('data', (data) => {
                if (data.type === 'message') {
                    addMessage(data.username, data.text);
                } else if (data.type === 'file') {
                    receiveFile(data.file, data.filename);
                }
            });
        }
    }

    // Handle file reception
    function receiveFile(fileData, filename) {
        const link = document.createElement("a");
        link.href = fileData;
        link.download = filename;
        link.textContent = `Download file: ${filename}`;
        messagesDiv.appendChild(link);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Enable chat inputs after connection
    function enableChat() {
        usernameInput.disabled = false;
        messageInput.disabled = false;
        fileInput.disabled = false;
        sendButton.disabled = false;
    }

    // Handle peer creation and connection
    connectButton.onclick = () => {
        peer = new Peer(null, {
            host: '0.peerjs.com',  // PeerJS cloud server
            port: 443,
            secure: true
        });

        // If no peer ID entered, create a new one
        peer.on('open', (id) => {
            if (!peerIdInput.value) {
                addMessage("System", `Your Peer ID is: ${id}. Share this with your friend.`);
                peerIdInput.value = id;  // Display peer ID
            }
        });

        peer.on('error', (err) => {
            console.error(err);
            addMessage("Error", "Failed to connect or create Peer ID.");
        });

        // Connect to the peer ID entered
        connectToPeer();
    };

    // Send message or file
    sendButton.onclick = () => {
        const username = usernameInput.value || "Anonymous";
        const message = messageInput.value;

        if (message) {
            conn.send({ type: 'message', username, text: message });
            addMessage("You", message);
            messageInput.value = ""; // Clear message input
        }

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size <= MAX_FILE_SIZE_MB * 1024 * 1024) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    conn.send({ type: 'file', file: event.target.result, filename: file.name });
                    addMessage("You", `Sent file: ${file.name}`);
                };
                reader.readAsDataURL(file);
            } else {
                alert("File is too big! Max size is 5MB.");
            }
            fileInput.value = ""; // Clear file input
        }
    };
</script>

</body>
</html>
